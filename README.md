# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```


## Данные и типы данных, используемых в приложении

Единица товара

```ts
interface IProduct {
    id: string,
    description: string,
    image: string,
    title: string,
    category: string,
    price: number | null,
}
```

Детали заказа

```ts
interface IOrder {
    payment: 'card' | 'cash',
    email: string,
    phone: string,
    address: string,
    total: number,
    items: string[],
}
```

Данные заказа, используемые на этапе заполнения адреса
```ts
type TOrderAddressInfo = Pick<IOrder, 'payment' | 'address'>;
```

Данные заказа, используемые на этапе заполнения контактных данных
```ts
type TOrderContactInfo = Pick<IOrder, 'email' | 'phone'>;
```

Данные заказа используемые на этапах заполнения адреса и контактных данных
```ts
type TOrderFieldsInfo = TOrderAddressInfo & TOrderContactInfo;
```

Вспомогательный тип-аналог Partial<T>, но любое значение из T может быть null
```ts
type OrNullValue<T extends object> = {
    [P in keyof T]?: T[P] | null;
};
```

Интерфейс для модели данных товаров
```ts
interface IProductsData {
    _products: IProduct[],
    _previewId: IProduct['id'] | null,
    // для работы с товарами
    setProducts(products: IProduct[]): void,
    getProducts(): IProduct[],
    getProductById(id: IProduct['id']): IProduct,
    // для работы с id карточки для превью деталей
    setPreviewId(id: IProduct['id'] | null): void,
    getPreviewId(): IProduct['id'] | null,
}
```

Интерфейс для модели данных корзины
```ts
interface ICartData {
    _cartItems: IProduct[],
    // для изменения массива содержимого корзины
    clearCart(): void,
    addCartItem(product: IProduct): void,
    deleteCartItem(id: IProduct['id']): void,
    // не мутирующие методы для работы с содержимым корзины
    getCartItems(): IProduct[],
    getCartItemsIds(): Array<IProduct['id']>,
    getCartItemsCount(): number,
    getTotalCost(): number,
    validateTotalCost(): boolean,
}
```

Интерфейс для модели данных формы
```ts
interface IOrderData {
    _data: OrNullValue<IOrder>,
    _errors: Record<keyof TOrderFieldsInfo, string>,
    // для работы с ошибками
    validateFormFields(values: OrNullValue<TOrderFieldsInfo>):  void,
    setFieldError(fieldName: keyof TOrderFieldsInfo, error: string): void,
    deleteFieldError(fieldName: keyof TOrderFieldsInfo): void,
    getErrors(): Record<keyof TOrderFieldsInfo, string>,
    // для работы с данными из формы
    getPaymentValue(): IOrder['payment'] | null,
    setPaymentValue(value: IOrder['payment'] | null): void,
    getAddressValue(): IOrder['address'] | null,
    setAddressValue(value: IOrder['address'] | null): void,
    getEmailValue(): IOrder['email'] | null,
    setEmailValue(value: IOrder['email'] | null): void,
    getPhoneValue(): IOrder['phone'] | null,
    setPhoneValue(value: IOrder['phone'] | null): void,
    // для работы с остальными данными заказа
    setProductsIds(ids: IOrder['items'] | null): void,
    setTotalCost(value: IOrder['total'] | null): void,
    // общий метод очистки данных заказа
    clearOrderData(): void,
}
```

## Архитектура приложения

Код приложения разделен на слои согласно парадигме MVP:
- слой представления, отвечает за отображение данных на странице,
- слой данных, отвечает за хранение и изменение данных
- презентер, отвечает за связь представления и данных.

### Базовый код

#### Класс Api
Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект\
с заголовками запросов.
Методы:
- `get` - выполняет GET запрос на переданный в параметрах эндпоинт и возвращает промис с объектом, которым ответил\
сервер
- `post` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на\
эндпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть\
переопределен заданием третьего параметра при вызове.

#### Класс EventEmitter
Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в\
презентере для обработки событий и в слоях приложения для генерации событий.  
Основные методы, реализуемые классом описаны интерфейсом `IEvents`:
- `on` - подписка на событие
- `emit` - инициализация события
- `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие

#### Класс Component
Абстрактный класс, который будут расширять все наши классы представления. Содержит набор методов для работы с DOM-элементами.\
Конструктор класса принимает контейнер, куда рендерить товар (на основе нужного темплейта) и инстанc брокера событий

В полях класса хранятся следующие данные:
- _container: HTMLElement - элемент, переданный при создании экземпляра класса какой-либо вьюхи
- _events: IEvents - экземпляр класса `EventEmitter` для инициации событий при изменении данных.

Также класс предоставляет набор методов для взаимодействия с этими данными.
- render(data?: Partial<T>): HTMLElement - возвращает корневой DOM-element
- остальные методы описаны в самом классе

#### Класс LarekApi
Расширяет базовый класс Api и релизует конкретные методы для взаимодействия с бэкендом сервиса.
Конструктор принимает базовый урл CDN'a (для превращения относительных ссылок на картинки в абсолютные),
базовый урл до сервиса и опциональный набор параметров для http-запроса

В полях класса хранятся следующие данные:
- _cdnUrl: string - базовый урл CDN'a

Также класс предоставляет набор методов для взаимодействия с этими данными.
- getProductsInfo(): Promise<ApiListResponse<IProduct>> - возвращает информацию о товарах с сервера
- makeOrder(): Promise<{ id: string, total: number}> - метод создания заказа, возвращает информацию о заказе

### Слой данных

#### Класс ProductsDataModel
Класс отвечает за хранение и логику работы с товарами, доступными для заказа.\
Конструктор класса принимает инстанc брокера событий\

В полях класса хранятся следующие данные:
- _events: IEvents - экземпляр класса `EventEmitter` для инициации событий при изменении данных.
- _products: IProduct[] - массив объектов товаров
- _previewId: IProduct['id'] | null - id товара, выбранного для просмотра в модальном окне

Также класс предоставляет набор методов для взаимодействия с этими данными.
- setProducts(products: IProduct[]): void - заполняет массив товаров, инициирует событие изменения списка товаров,
доступных для заказа 
- getProducts(): IProduct[] - возвращает массив товаров
- getProductById(id: IProduct['id']): IProduct - возвращает товар по его id
- setPreviewId(id: IProduct['id'] | null): void - устанавливает id товара для превью, инициирует событие открытия
модального окна с деталями товара
- getPreviewId(): IProduct['id'] | null - возвращает id товара, детали которого нужно показать в модальном окне

#### Класс CartDataModel
Класс отвечает за хранение и логику работы с данными товаров в корзине\
Конструктор класса принимает инстанс брокера событий\

В полях класса хранятся следующие данные:
- _events: IEvents - экземпляр класса `EventEmitter` для инициации событий при изменении данных.
- _cartItems: IProduct[] - массив позиций корзины

Так же класс предоставляет набор методов для взаимодействия с этими данными.
- clearCart(): void - очистка содержимого корзины, инициирует событие изменения состава корзины
- addCartItem(product: IProduct): void - добавляет товар в корзину, инициирует событие изменения состава корзины
- deleteCartItem(id: IProduct['id']): void - удаляет товар из корзины, инициирует событие изменения состава корзины
- getCartItems(): IProduct[] - возвращает список товаров в корзине
- isProductInCart(id: IProduct['id']): boolean - проверяет наличие товара в корзине
- getCartItemsIds(): Array<IProduct['id']> - возвращает список  id-шников товаров в корзине
- getCartItemsCount(): number - возвращает кол-во товаров в корзине
- getTotalCost(): number - возвращает итоговую сумму товаров в корзине
- validateTotalCost(): boolean - проверяет валидность (неравенство нулю) итоговой сумму товаров в корзине, в случае
невалидности инициирует событие блокирования кнопки оформления заказа

#### Класс FormDataModel
Класс отвечает за хранение и логику работы с данными, вводимыми пользователем на этапе оформления заказа\
Конструктор класса принимает инстанс брокера событий\

В полях класса хранятся следующие данные:
- _events: IEvents - экземпляр класса `EventEmitter` для инициации событий при изменении данных.
- _data: OrNullValue<IOrder> - данные заказа,
- _errors: Record<keyof TOrderFieldsInfo, string> - объект с ошибками полей формы заказа

Так же класс предоставляет набор методов для взаимодействия с этими данными.
- validateFormFields(values: OrNullValue<TOrderFieldsInfo>): boolean - проверяет валидность (заполненность) полей формы
заказа, в случае невалидности инициирует событие с текстами ошибок конкретных полей
- setFieldError(fieldName: keyof TOrderFieldsInfo, error: string): void - устанавливает текст ошибки конкретного поля
формы заказа
- deleteFieldError(fieldName: keyof TOrderFieldsInfo): void - очищает ошибку конкретного поля формы заказа
- getErrors(): Record<keyof TOrderFieldsInfo, string> - возвращает объект с ошибками полей формы заказа
- getPaymentValue(): IOrder['payment'] | null - возвращает значение поля "Тип платежа"
- setPaymentValue(value: IOrder['payment'] | null): void - устанавливает значение поля "Тип платежа"
- getAddressValue(): IOrder['address'] | null - возвращает значение поля "Адрес"
- setAddressValue(value: IOrder['address'] | null): void - устанавливает значение поля "Адрес"
- getEmailValue(): IOrder['email'] | null - возвращает значение поля "Email"
- setEmailValue(value: IOrder['email'] | null): void - устанавливает значение поля "Email"
- getPhoneValue(): IOrder['phone'] | null - возвращает значение поля "Телефон"
- setPhoneValue(value: IOrder['phone'] | null): void - устанавливает значение поля "Телефон"
- setProductsIds(ids: IOrder['items'] | null): void - устанавливает список id'шников товаров для заказа
- setTotalCost(value: IOrder['total'] | null): void - устанавливает итоговую сумму всех позиций заказа
- clearOrderData(): void - очищает данные заказа
- getOrderData(): OrNullValue<IOrder> - возвращает данные заказа

### Классы представления
Все классы представления отвечают за отображение внутри контейнера (DOM-элемент) передаваемых в них данных. Каждый класс представления является расширением базового класса Component

#### Класс MainPageView
Отвечает за работу с основными элементами на главной странице приложения: списком товаров, корзиной и ее счетчиком\
Каждый класс представления является расширением базового класса Component\
Конструктор класса принимает инстанc брокера событий\

В полях класса хранятся следующие данные:
- _cartButton: HTMLButtonElement - элемент корзины, при клике генерирует событие открытия содержимого корзины
- _cartCounter: HTMLSpanElement - элемент счетчика товаров в корзине
- _mainPageWrapper: HTMLDivElement - обертка основного контента главной страницы
- _gallery: HTMLElement - контейнер для списка товаров

Так же класс предоставляет набор методов для взаимодействия с этими данными.
- setProducts(elements: HTMLElement[]): void - наполняет контейнер списка товаров содержимым
- setCartCounter(value: number): void - изменяет значение счетчика товаров в корзине
- toggleLocked(): void - блок/разблок основного интерфейса при открытой/закрытой модалке

#### Класс ProductView
Универсальный класс, отвечает за отображение товара
в списке товаров на главной странице/деталей товара в модалке/деталей товара в корзине/ и навешивание различных
слушателей событий в зависимости от того, где используется: клик по товару для превью деталей, кнопка
добавления/удаления товара в/из корзины.
Конструктор класса принимает контейнер, куда рендерить товар (на основе нужного темплейта), инстанc брокера событий, объект с обработчиками событий

В полях класса хранятся следующие данные:
- _title: HTMLHeadingElement - элемент с заголовком товара
- _category: HTMLSpanElement - элемент с категорией товара
- _image: HTMLImageElement - элемент с лого товара
- _price: HTMLSpanElement - элемент с ценой товара
- _description: HTMLParagraphElement - элемент с ценой товара
- _index: HTMLSpanElement - элемент с порядковым номером товара в корзине
- _actionButton: HTMLButtonElement - кнопка добавления/удаления товара в/из корзину(-ы) (в зависимости от того, есть ли уже этот товар в корзине), инициирует соответствующее событие

Так же класс предоставляет набор методов для взаимодействия с этими данными.
- сеттеры для полей карточки

#### Класс CartView
Отвечает за отображение корзины с товарами и навешивание слушателя клика по кнопке оформления заказа\
Конструктор класса принимает инстанc брокера событий\

В полях класса хранятся следующие данные:
- _cartItems: HTMLElement[] - элементы товаров
- _totalPrice: HTMLSpanElement - элемент с общей стоимостью всех товаров в корзине
- _makeOrderButton: HTMLButtonElement - кнопка оформления заказа, инициирует соответствующее событие

Так же класс предоставляет набор методов для взаимодействия с этими данными.
- сеттеры для полей корзины
- setMakeOrderButtonState(state: boolean): void - блокирует/разблокирует кнопку оформления заказа в зависимости
от валидности общей стоимости товаров в корзине

#### Класс ModalView
Отвечает за отображение модального окна. Так же предоставляет методы `open` и `close` для управления видимостью
модального окна. Устанавливает слушатели на клавиатуру, для закрытия модального окна по Esc, на клик в оверлей и кнопку-крестик для закрытия попапа.\
Конструктор класса принимает контейнер, куда рендерить товар и инстанc брокера событий\

В полях класса хранятся следующие данные:
- _content: HTMLElement - содержимое модального окна
- _closeButton: HTMLButtonElement - кнопка закрытия модального окна

Так же класс предоставляет набор методов для взаимодействия с этими данными.
- сеттеры для полей модалки
- open(): void - делает модальное окно видимым
- close(): void - скрывает модельное окно

#### Класс OrderFormView
Отвечает за отображение форм, установку слушателя на кнопку сабмита формы.\
Конструктор класса принимает контейнер, куда рендерить товар и инстанc брокера событий\

В полях класса хранятся следующие данные:
- _errors: HTMLSpanElement - элемент для ошибок валидации полей формы данного этапа
- _submitButton: HTMLButtonElement - кнопка перехода к следующему этапу оформления заказа, генерирует
соответствующее событие

Так же класс предоставляет набор методов для взаимодействия с этими данными.
- сеттеры для полей модалки
- setMakeNextButtonState(state: boolean): void - блокирует/разблокирует кнопку перехода к следующему этапу заполнения формы заказа в зависимости от валидности введенных данных на текущем этапе
- onFieldChange(name: string, value: string | null): void - в зависимости от изменяемого поля генерирует соответствующее событие

#### Класс OrderFormAddressView
Расширяет класс OrderFormView, отвечает за отображение формы на этапе заполнения адреса и типа доставки, установку
слушателей на поля ввода, кнопки выбора типа оплаты и кнопку перехода на следующий этап заполнения формы заказа.
Конструктор класса принимает контейнер, куда рендерить товар и инстанc брокера событий\

В полях класса хранятся следующие данные:
- _cardButton: HTMLButtonElement - кнопка выбора оплаты картой, генерирует соответствующее событие
- _cashButton: HTMLButtonElement - кнопка выбора оплаты наличными, генерирует соответствующее событие
- _addressInput: HTMLInputElement - поле ввода адреса, генерирует соответствующее событие

Так же класс предоставляет набор методов для взаимодействия с этими данными.
- сеттеры для полей модалки

#### Класс OrderFormContactView
Отвечает за отображение формы на этапе заполнения контактных данных, установку слушателей на поля ввода и кнопку нажатия оплаты.\
Конструктор класса принимает контейнер, куда рендерить товар и инстанc брокера событий\

В полях класса хранятся следующие данные:
- _emailInput: HTMLInputElement - поле ввода почты, генерирует соответствующее событие
- _phoneInput: HTMLInputElement - поле ввода телефона, генерирует соответствующее событие

Так же класс предоставляет набор методов для взаимодействия с этими данными.
- сеттеры для полей модалки

#### Класс OrderSuccessView
Отвечает за отображение информации о стоимости успешного заказа и навешивание слушателя клика по кнопке "За новыми покупками!"\
Конструктор класса принимает инстанc брокера событий\
В полях класса хранятся следующие данные:
- _totalPrice: HTMLParagraphElement - элемент с итоговой ценой заказа
- _actionButton: HTMLButtonElement - кнопка "За новыми покупками!", инициирует соответствующее событие закрытия модального окна, очистки данных корзины и заказа

Так же класс предоставляет набор методов для взаимодействия с этими данными.
- сеттеры для полей карточки

## Взаимодействие компонентов
Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера. Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`.
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

*Список всех событий, которые могут генерироваться в системе:*\
*События изменения данных (генерируются классами моделей данных)*
- `products:changed` - изменение массива товаров
- `cart:changed` - изменение массива позиций корзины
- `order:changed` - изменение данных формы заказа

*События, возникающие при взаимодействии пользователя с интерфейсом (генерируются классами, отвечающими за представление)*
- `product:select` - выбор товара для просмотра деталей
- `product:addToCart` - добавление товара в корзину
- `product:removeFromCart` - удаление товара из корзины
- `modal:open` - открытие модального окна
- `modal:close` - закрытие модального окна
- `cart:open` - просмотр содержимого корзины
- `cart:close` - закрытие просмотра содержимого корзины
- `orderForm:open` - открытие формы оформления заказа (на нужном шаге)
- `orderForm:close` - закрытие формы оформления заказа
- `orderForm:input` - изменение одного из полей ввода в форме заказа
- `orderForm:submit` - оформление заказа
- `orderForm:success` - успешное оформление заказа